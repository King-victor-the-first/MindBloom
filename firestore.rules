rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Grant moderators the ability to list all user profiles for the admin dashboard.
    // This rule is applied to the collection path.
    match /userProfiles/{document=**} {
      allow list: if get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.isModerator == true;
    }

    // Rules for accessing a single user profile document.
    match /userProfiles/{userId} {
      // A user can get or write to their own profile.
      allow get, write: if request.auth.uid == userId;
      
      // A moderator can get or write to any user's profile.
      allow get, write: if get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.isModerator == true;
      
      // Rules for the 'moodEntries' subcollection within a user's profile.
      match /moodEntries/{entryId} {
        // A user can read and write their own mood entries.
        allow read, write: if request.auth.uid == userId;
      }
    }

    // Rules for the group chat messages.
    match /groupChatMessages/{messageId} {
      // Any authenticated user can read all messages.
      allow read: if request.auth != null;
      // An authenticated user can create messages.
      allow create: if request.auth != null;
    }
  }
}
